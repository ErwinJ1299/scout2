rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if doctor has access to patient
    function doctorHasAccessToPatient(patientId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/patients/$(patientId)) &&
             get(/databases/$(database)/documents/patients/$(patientId)).data.doctorId == request.auth.uid;
    }
    
    // Users collection (stores user roles)
    match /users/{userId} {
      allow create: if isAuthenticated() && isOwner(userId);
      allow read, write: if isAuthenticated() && isOwner(userId);
      allow read: if isAuthenticated();
    }
    
    // Doctors collection - all authenticated users can read (for request system)
    match /doctors/{doctorId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(doctorId);
      allow update: if isAuthenticated() && (
        isOwner(doctorId) ||
        // Allow patients to update assignedPatientIds when accepting requests
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['assignedPatientIds', 'updatedAt']))
      );
      allow delete: if false;
    }
    
    // Patients collection - allow doctors to read all patients for browsing
    match /patients/{patientId} {
      // Allow read if: user owns it, or user is a doctor (for browsing/sending requests), or doctor is assigned
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(patientId);
      allow update: if isAuthenticated() && isOwner(patientId);
      allow delete: if false;
    }
    
    // Doctor-Patient Requests collection
    match /doctorPatientRequests/{requestId} {
      // Allow read for individual documents
      allow read: if isAuthenticated() && (
        resource.data.doctorId == request.auth.uid || 
        resource.data.patientId == request.auth.uid
      );
      // Allow list/query operations for doctors and patients
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.doctorId == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() && (
        // Patients can accept/reject requests
        (resource.data.patientId == request.auth.uid &&
         request.resource.data.status in ['accepted', 'rejected']) ||
        // Doctors can update their own sent requests (for fixing accepted ones)
        (resource.data.doctorId == request.auth.uid)
      );
      allow delete: if false;
    }
    
    // Readings collection
    match /readings/{readingId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        doctorHasAccessToPatient(resource.data.patientId)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
    }
    
    // Reminders collection
    match /reminders/{reminderId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        doctorHasAccessToPatient(resource.data.patientId)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
    }
    
    // Gamification Progress collection
    match /gamification/{progressId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        doctorHasAccessToPatient(resource.data.patientId)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      allow delete: if false;
    }
    
    // Task Completions collection
    match /taskCompletions/{completionId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        doctorHasAccessToPatient(resource.data.patientId)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // Clinical Notes collection
    match /clinicalNotes/{noteId} {
      // Doctors can create notes for patients they have access to
      allow create: if isAuthenticated() && 
        request.resource.data.doctorId == request.auth.uid;
      // Doctors can read, update, and delete their own notes
      allow read, update, delete: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid;
      // Patients can read notes written about them
      allow read: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      // Allow list/query operations for authenticated users
      allow list: if isAuthenticated();
    }

    // ==================== HEALTHVERSE GAMIFICATION ====================
    
    // Community Challenges collection
    match /communityChallenges/{challengeId} {
      // Everyone can read challenges
      allow read: if true;
      // Allow list/query operations
      allow list: if true;
      // Only doctors can create or delete challenges
      allow create, delete: if isAuthenticated() && 
        exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
      // Doctors can fully update challenges they created
      allow update: if isAuthenticated() && 
        exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
      // Patients can update only to join/leave (add/remove themselves from participants array)
      allow update: if isAuthenticated() && 
        exists(/databases/$(database)/documents/patients/$(request.auth.uid)) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants']) &&
        (
          // Adding themselves to participants (joining)
          (request.resource.data.participants.hasAll(resource.data.participants) &&
           request.resource.data.participants.toSet().difference(resource.data.participants.toSet()).hasOnly([request.auth.uid])) ||
          // Removing themselves from participants (leaving)
          (resource.data.participants.hasAll(request.resource.data.participants) &&
           resource.data.participants.toSet().difference(request.resource.data.participants.toSet()).hasOnly([request.auth.uid]))
        );
    }
    
    // Challenge Progress collection
    match /challengeProgress/{progressId} {
      // Patients can read their own progress
      allow read: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      // Doctors can read progress for challenges they created
      allow read: if isAuthenticated() && 
        exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
      // Allow list/query operations for authenticated users
      allow list: if isAuthenticated();
      // Patients can create and update their own progress
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      // System can delete (when leaving challenges)
      allow delete: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
    }
    
    // Reward Marketplace collection
    match /rewardMarketplace/{rewardId} {
      // Everyone can read available rewards
      allow read: if true;
      // Allow list/query operations
      allow list: if true;
      // Only admins/doctors can manage rewards (for now, allow doctors)
      allow create, update, delete: if isAuthenticated() && 
        exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
    }
    
    // Reward Wallet collection
    match /rewardWallet/{walletId} {
      // Patients can read and update their own wallet
      allow read, update: if isAuthenticated() && 
        isOwner(walletId);
      // Allow creation of wallet when user first accesses it
      allow create: if isAuthenticated() && 
        request.resource.data.patientId == request.auth.uid;
      // Doctors can read patient wallets (for verification)
      allow read: if isAuthenticated() && 
        exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
    }
    
    // ==================== AI HEALTH COACH ====================
    
    // Health Coach Chats collection
    match /healthCoachChats/{chatId} {
      // Users can read their own chat messages
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Users can create messages for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      // Users can update and delete their own messages
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Allow list/query operations for own messages only
      allow list: if isAuthenticated() && 
        request.query.where.userId == request.auth.uid;
    }
    
    // Conversations collection - chat threads between patient and doctor
    match /conversations/{conversationId} {
      // Allow read if user is a participant
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      // Allow list/query with array-contains on participants (Firestore will filter results automatically)
      allow list: if isAuthenticated();
      // Allow create if user is one of the participants
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      // Allow update if user is a participant (for lastMessage, unreadCount updates)
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      // Don't allow deletion
      allow delete: if false;
    }
    
    // Messages subcollection - individual messages within conversations
    match /conversations/{conversationId}/messages/{messageId} {
      // Allow list/query for authenticated users (Firestore filters based on parent)
      allow list: if isAuthenticated();
      // Allow read if parent conversation includes user
      allow read: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      // Allow create if user is in the conversation
      allow create: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
        request.resource.data.senderId == request.auth.uid;
      // Allow update for marking as read
      allow update: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      // Don't allow deletion
      allow delete: if false;
    }
    
    // Video calls collection - for WebRTC signaling (v2)
    match /videoCalls/{callId} {
      // Allow read for any authenticated user
      // The document contains caller/receiver IDs for access control in app logic
      allow read: if isAuthenticated();
      
      // Allow create if user is the caller
      allow create: if isAuthenticated() && 
        request.resource.data.caller == request.auth.uid;
      
      // Allow update for any authenticated user (caller, receiver need to add ICE candidates)
      allow update: if isAuthenticated();
      
      // Allow delete if user is caller or receiver
      allow delete: if isAuthenticated() && 
        (resource.data.caller == request.auth.uid || resource.data.receiver == request.auth.uid);
    }
    
    // ICE Candidates subcollection for video calls
    match /videoCalls/{callId}/iceCandidates/{candidateId} {
      // Allow authenticated users to read/write ICE candidates
      // Parent videoCalls rules already restrict who can access calls
      allow read, write: if isAuthenticated();
    }
    
    // Wearable Devices collection
    match /wearableDevices/{deviceId} {
      // Users can read their own devices
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create devices for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own devices
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own devices
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow list/query for user's devices
      allow list: if isAuthenticated();
    }
    
    // Health Metrics collection (TEMPORARY: Open for debugging)
    match /healthMetrics/{metricId} {
      // Temporarily allow all reads for authenticated users
      allow read, list: if isAuthenticated();
      // Users can create metrics for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own metrics
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own metrics
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Activity Goals collection
    match /activityGoals/{userId} {
      // Users can read their own goals
      allow read: if isAuthenticated() && isOwner(userId);
      // Users can create their own goals
      allow create: if isAuthenticated() && isOwner(userId);
      // Users can update their own goals
      allow update: if isAuthenticated() && isOwner(userId);
      // Users can delete their own goals
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ========== WELLNESS COINS SYSTEM ==========
    
    // User Stats - READ ONLY for wellness coin fields
    match /userStats/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      // Block direct updates to rewardTokens, totalTokensEarned, totalTokensSpent
      // Only allow updates if these fields remain unchanged (server-side only)
      allow update: if isAuthenticated() && isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'rewardTokens', 
          'totalTokensEarned', 
          'totalTokensSpent',
          'hpConvertedToday'
        ]));
    }
    
    // Transactions - READ ONLY (server creates them)
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can write
    }
    
    // Wellness Rewards - Public read, admin-only write
    match /rewards/{rewardId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin/server can write
    }
    
    // Redemptions - Users can read their own
    match /redemptions/{redemptionId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can write
    }
    
    // ========== OUTCOME-BASED REWARDS SYSTEM ==========
    
    // Outcome Rules - Read-only for users, admin-only write
    match /outcomeRules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin/server can write
    }
    
    // Outcome Rewards - Users can read their own
    match /outcomeRewards/{rewardId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can write
    }
    
    // ========== SMART MEDICINE ORDERING SYSTEM ==========
    
    // Medicine Orders - Users can read/create their own
    match /medicineOrders/{id} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Prescription Uploads - Users can read/create their own
    match /prescriptionUploads/{id} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // ========== HEALTH ALERTS ANOMALY DETECTION SYSTEM ==========
    
    // Health Alerts - Patients can read their own, Doctors can read/update for their patients
    match /healthAlerts/{alertId} {
      // Patients can read their own alerts
      allow read: if isAuthenticated() && 
        resource.data.patientId == request.auth.uid;
      
      // Doctors can read alerts for their assigned patients
      allow read: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid;
      
      // Doctors can update (acknowledge/resolve) alerts for their patients
      allow update: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'status', 'acknowledgedBy', 'acknowledgedAt', 'resolvedBy', 
          'resolvedAt', 'doctorNotes', 'actionTaken'
        ]);
      
      // Only server/API can create alerts
      allow create: if false;
      allow delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
